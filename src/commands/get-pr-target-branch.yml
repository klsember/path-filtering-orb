description: Get GitHub PR Target Branch (if exists)
parameters:
  organization:
    description: github project organization
    type: string
    default: $CIRCLE_PROJECT_USERNAME
  repository:
    description: github project reponame
    type: string
    default: $CIRCLE_PROJECT_REPONAME
  github_token:
    description: github access token
    type: string
    default: $GITHUB_ACCESS_TOKEN
steps:
  - run:
      name: Get Pull Request Target Branch
      command: >
        # Check `jq` dependency

        if ! (command -v jq >/dev/null 2>&1); then
          echo "This command requires jq to be installed"
          exit 1
        fi

        if [[ -n $CIRCLE_PULL_REQUEST ]]; then
          ## Get pull request number from URL
          PR_NUMBER=$(echo "$CIRCLE_PULL_REQUEST" | sed "s/.*\/pull\///")
          echo "PR_NUMBER: $PR_NUMBER"
          echo "export GITHUB_PR_NUMBER=$PR_NUMBER" >> $BASH_ENV

          ## Create GH API to get target branch
          API_GITHUB="https://api.github.com/repos/$ORGANIZATION/$REPOSITORY"
          PR_REQUEST_URL="$API_GITHUB/pulls/$PR_NUMBER"
          PR_RESPONSE=$(curl -H "Authorization: token $GITHUB_TOKEN" "$PR_REQUEST_URL")

          PR_TARGET_BRANCH=$(echo $PR_RESPONSE | jq -e '.base.ref' | tr -d '"')
          echo "PR_TARGET_BRANCH: $PR_TARGET_BRANCH"
          echo "export GITHUB_PR_TARGET_BRANCH='${PR_TARGET_BRANCH/"'"/}'" >> $BASH_ENV
        else
          echo "There is no pull request associated with this commit"
        fi
      environment:
        ORGANIZATION: << parameters.organization >>
        REPOSITORY: << parameters.repository >>
        GITHUB_TOKEN: << parameters.github_token >>
  - run:
      name: Set Target Branch or Current Branch as Base Revision
      command: |
        if [[ -n $CIRCLE_PULL_REQUEST ]]; then
          echo 'export BASE_REVISION=$GITHUB_PR_TARGET_BRANCH' >> $BASH_ENV; source $BASH_ENV
        else
          echo 'export BASE_REVISION=$CIRCLE_BRANCH' >> $BASH_ENV; source $BASH_ENV
        fi
        echo "Will be using" $BASE_REVISION "as the Target Base-Revision branch"
